---
layout: post
title: MySQL索引
category: other
tags: [other]
excerpt:  MySQL索引介绍
---
## 前言 
工作开发中经常会用到一些索引，有时候也会对索引做一些优化。如果让我全面介绍一下MySQL的索引，还真说不太清楚。本文希望查阅了一些资料，希望能够
将MySQL索引做一次简单地介绍，便于自己对索引有系统性的认识。

## 索引概念
MySQL官方对索引的定义为：索引（Index）是帮助MySQL高效获取数据的数据结构。提取句子主干，就可以得到索引的本质：索引是数据结构。
### 基础认知
- 索引是辅助MySQL高效获取数据的数据结构，提高数据的查询效率
- 索引是排好序的快速查找数据结构，where后的条件和排序，和查询的列都会影响查询效率

### 索引分类
- 存储结构: B树索引、Hash索引、全文索引和R树索引
- 应用层次: 普通索引、唯一索引、复合索引
- 数据物理顺序关系: 聚集索引、非聚集索引

## 索引的实现
### 哈希索引
只有Memory(内存)存储引擎支持哈希索引，哈希索引引用索引列的值计算该值的hashCode，然后根据hashCode对应的位置该值所在行的物理位置，因为使用
散列算法，访问速度非常快。因为是散列的分布方式，哈希索引不支持范围查找和排序功能

### 全文索引
FULLTEXT（全文）索引，仅可用于MyISAM和InnoDB存储引擎，针对较大的数据，生成全文索引非常的消耗时间和空间。对于文本大对象的数据，匹配需要很
长的时间，大大增加响应时间。通过添加全文索引，会给文本生成单词的清单，在索引查找时根据单词清单来索引查找数据。
> MySQL的全文索引只支持英文，中文目前不支持
> 检索的字符串最短是4个字节，太短的字符词条会被忽略

### B树索引
mysql默认存储引擎innodb只显式支持B-Tree(从技术上来说是B+Tree)索引，对于频繁访问的表，innodb会透明建立自适应hash索引，即在B树索引基础上
建立hash索引，可以显著提高查找效率，对于客户端是透明的，不可控制的，隐式的。

### R树索引
R-Tree是一种空间索引数据结构，R树是一种用于处理多维数据的数据结构，用来访问二维或者更高维区域对象组成的空间数据。R树是平衡树，其有两类结点：
叶子结点和非叶子结点。每一个结点由若干个索引项构成。对于叶子结点，索引项形如(Index，Obj_ID)。其中，Index表示包围空间数据对象的最小外接
矩形MBR，Obj_ID标识一个空间数据对象。对于一个非叶子结点，它的索引项形如(Index，Child_Pointer)。 Child_Pointer 指向该结点的子结点。
Index仍指一个矩形区域，该矩形区域包围了子结点上所有索引项MBR的最小矩形区域。
                                                          

### B树索引
B树索引是最常见的索引结构，MySQL的MyISAM、InnoDB引擎默认均使用B树索引。B树就像一棵“m叉搜索树”（m是子树的最大个数），时间复杂度为O(logm(n))。
B树设计了一种高效简单的维护操作，使B树的深度维持在约log(ceil(m/2))(n)~logm(n)之间，大大降低树高。B树与AVL的时间复杂度是相同的，但由于B树
的层数少，磁盘IO次数少，实践中B树的性能要优于AVL等二叉树。

## B树详解
### 磁盘的IO请求过程
磁盘可以从划分成柱面、磁道和扇区，每一个扇区是以512字节为单位的，磁盘要想确定一个数据的位置，首先传入数据的虚拟地址，控制器将这个虚拟地址转换为物理地址，每一个物理地址由<柱面号，磁道号，扇区号>唯一确定。
磁盘为了读取扇区号上的数据：

- 首先必须找到柱面，即磁头需要移动对准相应磁道，这个过程叫做寻道，所耗费时间叫做寻道时间。
- 然后目标扇区旋转到磁头下，即磁盘旋转将目标扇区旋转到磁头下，这个过程耗费的时间叫做旋转时间。
- 之后读取数据，拷贝到内存中，这个过程耗费的时间叫做数据传输时间。为了提高IO的效率，磁盘每次读取数据的时候，并不是严格按照一个扇区返回，
而是采用预读策略，按照页为单位的，一般是4k。

### B树索引结构
建立索引的目的为了优化查找过程，B树作为索引结构，如果存储的数据量很大时会导致B-Tree的深度较大，增大查询的磁盘IO次数，从而影响到查询效率。
而在B+Tree中，所有数据记录节点都是按照值大小放在一层的叶子节点上，而非叶子节点上只存储key值信息，这样可以大大加大每个节点存储的key值数量，
降低B+Tree的高度。B+Tree相对B-Tree的基础有两大变化：
- 数据是存在叶子节点上的
- 数据节点之间是有指针指向的
![bplustree](/assets/images/2019/03/mysql_index_bplustree.png)
MyISAM索引实现如下：
![myISAM](/assets/images/2019/03/mysql_index_myisam_btree.png)
InnoDB索引实现如下：
![InnoDB](/assets/images/2019/03/mysql_index_innodb_btree.png)
InnoDB索引存储结构：
![InnoDB索引结构](/assets/images/2019/03/mysql_index_innodb_struct.png)

## 索引总结
Q1:为什么索引结构默认使用B-Tree，而不是hash，二叉树，红黑树？
- hash：虽然可以快速定位，但是没有顺序，IO复杂度高。
- 二叉树：树的高度不均匀，不能自平衡，查找效率跟数据有关（树的高度），并且IO代价高。
- 红黑树：树的高度随着数据量增加而增加，IO代价高。
Q2:为什么官方建议使用自增长主键作为索引。
结合B+Tree的特点，自增主键是连续的，在插入过程中尽量减少页分裂，即使要进行页分裂，也只会分裂很少一部分。并且能减少数据的移动，每次插入都是
插入到最后。总之就是减少分裂和移动的频率。
Q3:什么是最左前缀匹配
在B+树中， 所有键值都是有序的， 对于联合索引来说， 建立索引时索引列的顺序意味着索引首先按照最左列进行排序，其次再为第二列、第三列等等。
所以一个联合索引各节点一定是按第一列严格排序的， 但是后边的列并不是整体完全有序， 只是局部有序（第一列键值相同的情况下）。


## 参考
- [图解MySQL索引](https://www.cnblogs.com/liqiangchn/p/9060521.html)
- [深入理解MySQL索引原理和实现](https://blog.csdn.net/tongdanping/article/details/79878302)
- [MySQL索引原理](https://zhuanlan.zhihu.com/p/34840329)
- [从B树、B+树、B*树谈到R 树](https://blog.csdn.net/v_JULY_v/article/details/6530142/)
- [MySQL的B树索引与索引优化](https://www.cnblogs.com/lfs2640666960/p/8550452.html)
- [http://harlon.org/2018/03/26/datastructureadvancedtree/](http://harlon.org/2018/03/26/datastructureadvancedtree/)
- [深入理解MySQL底层实现](http://harlon.org/2018/06/20/database/)
- [MySQL索引背后的数据结构及算法原理](http://blog.codinglabs.org/articles/theory-of-mysql-index.html)
- [MYSQL-B+TREE索引原理](https://www.jianshu.com/p/486a514b0ded)
- [ysql 索引原理及优化](http://www.cnblogs.com/hellojesson/p/6001685.html)